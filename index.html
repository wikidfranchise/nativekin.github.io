<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NativeKin Tribal Directory</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      padding: 20px;
      background-color: #f7f7f7;
      color: #222;
      margin: 0;
    }
    h1 {
      font-size: 2rem;
      color: #008080; /* Teal color */
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .search-container {
      position: relative;
      width: 100%;
      max-width: 700px; /* Increased max width */
      margin: 20px auto;
    }

    input[type="text"]#tribeSearchInput {
      padding: 12px 15px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 100%;
      box-sizing: border-box;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input[type="text"]#tribeSearchInput:focus {
      border-color: #008080;
      outline: none;
      box-shadow: 0 0 8px rgba(0, 128, 128, 0.3);
    }

    .custom-dropdown {
      display: none; /* Hidden by default */
      position: absolute;
      background-color: white;
      width: 100%;
      border: 1px solid #ccc;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 350px; /* Increased height */
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }

    .custom-dropdown .dropdown-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 15px;
    }
    .custom-dropdown .dropdown-item:last-child {
      border-bottom: none;
    }
    .custom-dropdown .dropdown-item:hover {
      background-color: #f0f0f0;
    }
    .custom-dropdown .dropdown-item.highlighted {
      background-color: #e0e0e0; /* For keyboard navigation */
    }
    .custom-dropdown .no-results {
        padding: 10px 15px;
        color: #777;
        font-style: italic;
    }

    .card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 700px; /* Consistent max width */
      margin: 30px auto;
    }
    .card div {
        margin-bottom: 8px;
        line-height: 1.6;
    }
    .card div:last-child {
        margin-bottom: 0;
    }
    .card strong {
        color: #005050; /* Darker teal for emphasis */
        font-size: 1.25em; /* Slightly larger tribe name */
    }
    .image-preview-link {
        display: block; /* Make the link a block for better layout */
        margin-top: 15px;
    }
    .image-preview {
      width: 100%;
      max-width: 600px;
      border-radius: 8px;
      border: 1px solid #ddd;
      display: block;
      margin-left: auto;
      margin-right: auto;
      transition: transform 0.2s ease-in-out;
    }
    .image-preview:hover {
        transform: scale(1.02); /* Slight zoom on hover */
    }
    .error-message {
        color: red;
        text-align: center;
        padding: 10px;
        background-color: #ffe0e0;
        border: 1px solid red;
        border-radius: 8px;
        margin: 20px auto;
        max-width: 700px;
    }
  </style>
</head>
<body>
  <h1>NativeKin Tribal Directory</h1>

  <div class="search-container">
    <input type="text" id="tribeSearchInput" placeholder="Search or select your tribe..." autocomplete="off" />
    <div id="customTribeDropdown" class="custom-dropdown">
      </div>
  </div>

  <div id="tribeInfoOutput"></div>
  <div id="newsArticlesOutput"></div>

  <script>
    const searchInput = document.getElementById('tribeSearchInput');
    const dropdown = document.getElementById('customTribeDropdown');
    const tribeInfoContainer = document.getElementById('tribeInfoOutput');
    // const newsContainer = document.getElementById('newsArticlesOutput'); // For later

    let allTribalData = [];
    let currentKeyboardFocus = -1; // For keyboard navigation in dropdown

    // --- DATA FETCHING ---
    async function fetchTribalData() {
      try {
        const response = await fetch('/data/tribalDirectory.json'); 
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}. Failed to load tribalDirectory.json. Ensure the file exists at '/data/tribalDirectory.json' (from the root of your site) and is valid.`);
        }
        const data = await response.json();
        allTribalData = data
          .filter(tribe => tribe.Tribe && tribe.Tribe.trim() !== "") 
          .sort((a, b) => a.Tribe.localeCompare(b.Tribe)); 
        
      } catch (error) {
        console.error('‚ùå Error fetching or parsing tribal data:', error);
        tribeInfoContainer.innerHTML = `<div class="error-message">Error loading tribal directory. Please check the console for details or try again later. <br>Details: ${error.message}</div>`;
      }
    }

    // --- RENDERING FUNCTIONS ---
    function renderTribeInfo(tribe) {
      if (!tribe) {
        tribeInfoContainer.innerHTML = ''; 
        return;
      }

      const websiteLink = (tribe.Website && tribe.Website.trim() !== '') ? tribe.Website.trim() : '#';
      
      const imageSource = (tribe.SnapshotFilename && tribe.SnapshotFilename.trim() !== '' && tribe.SnapshotFilename.trim().toLowerCase() !== 'placeholder.png')
        ? `/media/hpsnaps/${tribe.SnapshotFilename.trim()}` 
        : '/media/hpsnaps/placeholder.png'; 

      tribeInfoContainer.innerHTML = `
        <div class="card">
          <div><strong>${tribe.Tribe || 'N/A'}</strong></div>
          <div>
            ${tribe.City || ''}${tribe.City && tribe.State ? ', ' : ''}${tribe.State || ''} ${tribe.Zip || ''}
          </div>
          <div>Phone: ${tribe.Phone || 'N/A'}</div>
          <div><em>Region: ${tribe.Region || 'N/A'}</em></div>
          <a href="${websiteLink}" target="_blank" rel="noopener noreferrer" class="image-preview-link" title="Visit ${tribe.Tribe}'s Website">
            <img src="${imageSource}" alt="Snapshot of ${tribe.Tribe || 'Tribe'}'s website" class="image-preview"
                 onerror="this.onerror=null; this.src='/media/hpsnaps/placeholder.png'; console.warn('Image not found: ${imageSource}, using placeholder.');" />
          </a>
        </div>
      `;
    }

    function populateDropdown(tribesToDisplay) {
      dropdown.innerHTML = ''; 
      currentKeyboardFocus = -1; 

      if (tribesToDisplay.length === 0 && searchInput.value.trim() !== '') { // Only show "no results" if user has typed something
        dropdown.innerHTML = '<div class="no-results">No tribes match your search.</div>';
      } else if (tribesToDisplay.length === 0 && searchInput.value.trim() === '') {
        // If input is empty and no tribes (e.g. initial load error), don't show "no results" unless intended.
        // Or, show a specific message like "Type to search or select from list" if allTribalData is truly empty.
        // For now, just don't show "no results" if input is blank and list is blank.
         dropdown.style.display = 'none'; // Hide if truly empty and no search term
         return;
      }


      tribesToDisplay.forEach(tribe => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('dropdown-item');
        itemDiv.textContent = tribe.Tribe;
        itemDiv.addEventListener('mousedown', (e) => { 
          e.preventDefault(); 
          searchInput.value = tribe.Tribe; // Set input value to selected tribe
          renderTribeInfo(tribe);
          dropdown.style.display = 'none';
        });
        dropdown.appendChild(itemDiv);
      });
      
      // Only display dropdown if there are items or a "no results" message to show
      if (dropdown.hasChildNodes()) {
          dropdown.style.display = 'block';
      } else {
          dropdown.style.display = 'none';
      }
    }

    // --- EVENT LISTENERS ---
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase().trim();
      const filteredTribes = allTribalData.filter(tribe =>
        tribe.Tribe.toLowerCase().includes(query)
      );
      populateDropdown(filteredTribes);
      
      // If the input is cleared by typing, also clear the tribe info card
      if (query === '') {
        tribeInfoContainer.innerHTML = '';
      }
    });

    // MODIFIED: Simplified focus listener
    searchInput.addEventListener('focus', () => {
      // When the input is focused, always show the full list of tribes initially
      // (or a filtered list if the user has already typed something and then re-focused).
      // The 'input' event will handle further filtering if the user then types.
      const query = searchInput.value.toLowerCase().trim();
      const tribesToDisplay = allTribalData.filter(tribe => 
          tribe.Tribe.toLowerCase().includes(query) // This will show all if query is empty
      );
      populateDropdown(tribesToDisplay);
    });
    
    searchInput.addEventListener('blur', () => {
        // Use a small timeout to allow mousedown event on dropdown items to fire first
        setTimeout(() => {
            if (!dropdown.matches(':hover')) { // Only hide if mouse isn't over the dropdown
                dropdown.style.display = 'none';
            }
        }, 150); // 150ms delay
    });


    searchInput.addEventListener('keydown', (e) => {
      const items = dropdown.querySelectorAll('.dropdown-item');
      if (!dropdown.style.display || dropdown.style.display === 'none') {
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
            // If dropdown is not visible and user presses arrow keys, show it
            const query = searchInput.value.toLowerCase().trim();
            const tribesToDisplay = allTribalData.filter(tribe => 
                tribe.Tribe.toLowerCase().includes(query)
            );
            populateDropdown(tribesToDisplay);
            // Update items query selector after populating
            const newItems = dropdown.querySelectorAll('.dropdown-item');
            if (newItems.length > 0) {
                 currentKeyboardFocus = (e.key === 'ArrowDown') ? 0 : newItems.length -1;
                 updateKeyboardFocus(newItems);
            }
            return; // Prevent further processing in this keydown event
        }
      }


      if (items.length === 0 && e.key !== 'Escape') return;


      if (e.key === 'ArrowDown') {
        e.preventDefault();
        currentKeyboardFocus++;
        if (currentKeyboardFocus >= items.length) currentKeyboardFocus = 0;
        updateKeyboardFocus(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        currentKeyboardFocus--;
        if (currentKeyboardFocus < 0) currentKeyboardFocus = items.length - 1;
        updateKeyboardFocus(items);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (currentKeyboardFocus > -1 && items[currentKeyboardFocus]) {
          items[currentKeyboardFocus].dispatchEvent(new MouseEvent('mousedown')); 
        } else if (items.length > 0) { 
          const directMatch = allTribalData.find(t => t.Tribe.toLowerCase() === searchInput.value.toLowerCase().trim());
          if (directMatch) {
              searchInput.value = directMatch.Tribe;
              renderTribeInfo(directMatch);
              dropdown.style.display = 'none';
          } else if (items.length === 1 && items[0].textContent !== 'No tribes match your search.') {
             items[0].dispatchEvent(new MouseEvent('mousedown')); 
          }
        }
      } else if (e.key === 'Escape') {
        dropdown.style.display = 'none';
      }
    });

    function updateKeyboardFocus(items) {
      items.forEach(item => item.classList.remove('highlighted'));
      if (items[currentKeyboardFocus] && items[currentKeyboardFocus].classList) { // Check if classList exists
        items[currentKeyboardFocus].classList.add('highlighted');
        items[currentKeyboardFocus].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    // Removed the global click listener, relying on blur with a timeout now.
    // document.addEventListener('click', (e) => {
    //   const searchContainer = searchInput.closest('.search-container');
    //   if (searchContainer && !searchContainer.contains(e.target)) {
    //     dropdown.style.display = 'none';
    //   }
    // });

    // --- INITIALIZATION ---
    fetchTribalData(); 

  </script>
  <script data-goatcounter="https://nativekin.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
```

After some internal review of the logic, I've slightly adjusted the `focus` listener to be more robust: it will show a list filtered by the current input (which means all tribes if the input is empty, or a pre-filtered list if the user clicks back into a field that already has text). The `input` listener then continues to filter as the user types.

I also made some refinements to the `blur` behavior and keyboard navigation to make it a bit smoother, especially around showing and hiding the dropdown.
The condition in `populateDropdown` for displaying "No tribes match your search" has also been tweaked to only show if the user has actually typed something. And if the input is cleared, the tribe info card will also clear.

Try this version out. It should behave more like what you're expecting when you click back into the search fie